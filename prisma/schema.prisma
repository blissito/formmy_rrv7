generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "mongodb"
  url      = env("MONGO_ATLAS")
}

enum CustomFieldTypes {
  text
  select
}

type CustomInput {
  type        CustomFieldTypes
  title       String
  name        String           @default("no_name")
  placeholder String?
  isRequired  Boolean          @default(false)
  options     String[]         @default([])
}

model Answer {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  data      Json?
  projectId String   @db.ObjectId
  project   Project  @relation(fields: [projectId], references: [id])
  favorite  Boolean  @default(false)
  deleted   Boolean  @default(false)
  opened    Boolean? @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

type Notifications {
  new     Boolean  @default(true)
  members Boolean? @default(false)
  warning Boolean? @default(false)
}

type ProjectSettings {
  notifications Notifications
}

type ProjectConfig {
  theme        String?
  ctaColor     String?
  inputs       String[]
  border       String?
  confetti     String?
  message      String?
  icon         String?
  customInputs CustomInput[]
  watermark    Boolean?      @default(false)
}

type Rights {
  read   Boolean @default(true)
  write  Boolean @default(false)
  update Boolean @default(false)
  delete Boolean @default(false)
}

enum Statuses {
  pending
  active
  rejected
}

enum Role {
  VIEWER
  EDITOR
  ADMIN
}

enum ResourceType {
  PROJECT
  CHATBOT
}

model Permission {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  email         String
  status        Statuses     @default(pending)
  role          Role         @default(VIEWER)
  can           Rights?
  notifications Boolean?     @default(true)
  resourceType  ResourceType @default(PROJECT)

  // Usuario relacionado
  user   User?   @relation("UserPermissions", fields: [userId], references: [id])
  userId String? @db.ObjectId

  // Recurso relacionado (uno u otro)
  project   Project? @relation(fields: [projectId], references: [id])
  projectId String?  @db.ObjectId
  chatbot   Chatbot? @relation(fields: [chatbotId], references: [id])
  chatbotId String?  @db.ObjectId

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

enum FormmyTypes {
  contact
  subscription
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

enum ContactStatus {
  NEW
  CONTACTED
  SCHEDULED
  NEGOTIATING
  ON_HOLD
  CLOSED_WON
  CLOSED_LOST
}

model Project {
  isActive    Boolean          @default(true)
  status      ProjectStatus    @default(ACTIVE)
  slug        String           @unique
  id          String           @id @default(auto()) @map("_id") @db.ObjectId
  userId      String           @db.ObjectId
  name        String
  User        User             @relation(fields: [userId], references: [id])
  email       String?
  permissions Permission[]
  type        FormmyTypes?     @default(contact)
  answers     Answer[]
  config      ProjectConfig
  settings    ProjectSettings?

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

enum Plans {
  FREE
  TRIAL
  STARTER
  PRO
  ENTERPRISE
}

enum ApiKeyType {
  LIVE
  TEST
}

model User {
  name            String?
  email           String       @unique
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  access_token    String?
  picture         String?
  provider        String?
  refresh_token   String?
  plan            Plans        @default(FREE)
  trialStartedAt  DateTime? // Fecha espec√≠fica de inicio del trial (para marketing/promociones)
  customerId      String?      @unique
  subscriptionIds String[]
  projects        Project[]
  chatbots        Chatbot[]
  apiKeys         ApiKey[]
  referrals       Referral[]   @relation("Referrer")
  permissions     Permission[] @relation("UserPermissions")
  traces          Trace[]
  satInvoices     SatInvoice[] @relation("UserSatInvoices")
  satContacts     SatContact[] @relation("UserSatContacts")

  // Tool Credits Tracking (para Parser Avanzado y otras herramientas)
  toolCreditsUsed     Float     @default(0) // Cr√©ditos MENSUALES consumidos en el mes actual (soporta decimales: 0.5, 1.5)
  creditsResetAt      DateTime? @default(now()) // √öltima fecha de reset mensual (nullable para usuarios existentes)
  purchasedCredits    Float     @default(0) // Cr√©ditos COMPRADOS que NO caducan (se usan primero, soporta decimales)
  lifetimeCreditsUsed Float     @default(0) // Total hist√≥rico de cr√©ditos usados (analytics, soporta decimales)

  // Voice Credits Tracking (para LiveKit Voice AI)
  voiceCreditsUsed Int   @default(0) // Cr√©ditos de voz consumidos en el mes actual
  voiceMinutesUsed Float @default(0) // Minutos de conversaci√≥n consumidos

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

enum ChatbotStatus {
  DRAFT
  ACTIVE
  INACTIVE
  DELETED
}

type ChatbotNotifications {
  weeklyDigest  Boolean @default(true)
  usageLimit    Boolean @default(true)
  configChanges Boolean @default(false)
}

type ChatbotSecurity {
  allowedDomains String[]
  rateLimit      Int      @default(100)
  status         String   @default("public")
}

type ChatbotSettings {
  notifications ChatbotNotifications
  security      ChatbotSecurity
}

enum ContextType {
  FILE
  LINK
  TEXT
  QUESTION
}

type ContextItem {
  id        String
  type      ContextType
  fileName  String?
  fileType  String?
  fileUrl   String?
  url       String?
  title     String?
  sizeKB    Int?
  content   String?
  routes    String[]    @default([])
  questions String?
  answer    String?
  createdAt DateTime

  // Metadata de parsing (solo para documentos parseados via Parser API)
  parsingMode    String? // ParsingMode enum como string
  parsingPages   Int?
  parsingCredits Int?
}

model Chatbot {
  id                 String            @id @default(auto()) @map("_id") @db.ObjectId
  slug               String            @unique
  name               String
  description        String?
  personality        String?
  welcomeMessage     String?
  goodbyeMessage     String?
  aiModel            String            @default("mistralai/mistral-small-3.2-24b-instruct")
  temperature        Float             @default(1)
  instructions       String?
  customInstructions String?
  contexts           ContextItem[]
  primaryColor       String?
  avatarUrl          String?
  theme              String?           @default("light")
  enableStreaming    Boolean           @default(false) // üö® STREAMING DESHABILITADO por defecto - problema cr√≠tico resuelto
  streamingSpeed     Int               @default(50)
  status             ChatbotStatus     @default(ACTIVE)
  isActive           Boolean           @default(true)
  conversationCount  Int               @default(0)
  monthlyUsage       Int               @default(0)
  contextSizeKB      Int               @default(0)
  settings           ChatbotSettings?
  userId             String            @db.ObjectId
  user               User              @relation(fields: [userId], references: [id])
  permissions        Permission[]
  conversations      Conversation[]
  integrations       Integration[]
  apiKeys            ApiKey[]
  scheduledActions   ScheduledAction[]
  contacts           Contact[]
  toolUsages         ToolUsage[]
  embeddings         Embedding[]
  traces             Trace[]
  satInvoices        SatInvoice[]      @relation("ChatbotSatInvoices")
  satContacts        SatContact[]      @relation("ChatbotSatContacts")
  voiceSessions      VoiceSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Contact {
  id       String        @id @default(auto()) @map("_id") @db.ObjectId
  name     String? // Nombre completo
  email    String? // Email de contacto
  phone    String? // Tel√©fono
  company  String? // Empresa/organizaci√≥n
  position String? // Cargo/posici√≥n
  website  String? // Sitio web
  notes    String? // Notas adicionales o contexto
  source   String        @default("chatbot") // Fuente: chatbot, whatsapp, etc.
  status   ContactStatus @default(NEW) // Estado del lead en el embudo

  // Relaciones
  chatbotId String  @db.ObjectId
  chatbot   Chatbot @relation(fields: [chatbotId], references: [id])

  conversationId String?       @db.ObjectId
  conversation   Conversation? @relation(fields: [conversationId], references: [id])

  // Metadatos
  capturedAt  DateTime @default(now())
  lastUpdated DateTime @updatedAt

  // √çndices para b√∫squeda eficiente
  @@index([email])
  @@index([chatbotId])
  @@index([capturedAt])
}

model ScheduledAction {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  chatbotId String  @db.ObjectId
  chatbot   Chatbot @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  type   String // 'email', 'webhook', 'sms'
  data   Json // everything needed to execute
  runAt  DateTime @map("run_at")
  status String   @default("pending") // 'pending', 'done', 'failed'

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("scheduled_actions")
}

// Vector embeddings para RAG sem√°ntico
model Embedding {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  chatbotId String  @db.ObjectId
  chatbot   Chatbot @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  // Contenido y vector
  content   String // Chunk de texto original
  embedding Float[] // Vector de 768 dimensiones (text-embedding-3-small)

  // Metadata para retrieval
  metadata Json // { contextId, contextType, title, fileName, url, chunkIndex }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([chatbotId])
  @@map("embeddings")
}

enum ConversationStatus {
  ACTIVE
  COMPLETED
  TIMEOUT
  DELETED
}

model Conversation {
  id           String             @id @default(auto()) @map("_id") @db.ObjectId
  sessionId    String             @unique
  visitorIp    String?
  visitorId    String?
  status       ConversationStatus @default(ACTIVE)
  startedAt    DateTime           @default(now())
  endedAt      DateTime?
  messageCount Int                @default(0)
  isFavorite   Boolean            @default(false)
  manualMode   Boolean            @default(false) // Para controlar respuestas manuales vs autom√°ticas
  chatbotId    String?            @db.ObjectId // ‚úÖ Nullable para permitir Ghosty (sin chatbot real)
  chatbot      Chatbot?           @relation(fields: [chatbotId], references: [id])
  messages     Message[]
  contacts     Contact[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

model Message {
  id                String       @id @default(auto()) @map("_id") @db.ObjectId
  content           String
  role              MessageRole
  deleted           Boolean      @default(false)
  picture           String?
  channel           String?
  externalMessageId String?
  tokens            Int? // Tokens totales (deprecated, usar inputTokens + outputTokens)
  inputTokens       Int? // Tokens de entrada (input)
  outputTokens      Int? // Tokens de salida (output/completion)
  cachedTokens      Int? // Cached input tokens (GPT-5-nano: 90% descuento)
  totalCost         Float? // Costo total en USD
  provider          String? // Proveedor: openai, anthropic, openrouter
  responseTime      Int?
  firstTokenLatency Int?
  aiModel           String? // Modelo de IA usado para generar esta respuesta (solo para ASSISTANT messages)
  conversationId    String       @db.ObjectId
  conversation      Conversation @relation(fields: [conversationId], references: [id])

  createdAt DateTime @default(now())
}

enum IntegrationType {
  WHATSAPP
  GOOGLE_CALENDAR
  GMAIL
  STRIPE
  SAT
  VOICE
}

model Integration {
  id           String          @id @default(auto()) @map("_id") @db.ObjectId
  platform     IntegrationType
  token        String? // Token de acceso para la API
  refreshToken String? // Token de actualizaci√≥n para OAuth
  isActive     Boolean         @default(true)

  // Campos espec√≠ficos de WhatsApp
  phoneNumberId      String? // ID del n√∫mero de tel√©fono en WhatsApp
  businessAccountId  String? // ID de la cuenta de negocio en WhatsApp
  webhookVerifyToken String? // Token para verificar el webhook de WhatsApp

  // Campos espec√≠ficos de Google Calendar
  calendarId   String? // ID del calendario (por defecto 'primary')
  clientId     String? // Client ID de OAuth 2.0
  clientSecret String? // Client Secret de OAuth 2.0
  redirectUri  String? // URI de redirecci√≥n para OAuth

  // Campos espec√≠ficos de Stripe
  stripeApiKey         String? // API Key de Stripe (secret key)
  stripePublishableKey String? // Publishable Key de Stripe
  stripeWebhookSecret  String? // Secret para validar webhooks de Stripe

  // Campos de auditor√≠a
  lastActivity DateTime? // √öltima actividad registrada
  errorMessage String? // √öltimo mensaje de error

  // Metadata JSON para configuraci√≥n espec√≠fica de cada integraci√≥n
  // Ej: VOICE ‚Üí {ttsVoiceId, voiceWelcome, ttsProvider, sttLanguage}
  metadata Json?

  // Relaciones
  chatbotId String  @db.ObjectId
  chatbot   Chatbot @relation(fields: [chatbotId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Constraint √∫nico: una integraci√≥n por plataforma por chatbot
  @@unique([platform, chatbotId], map: "platform_chatbot_unique")
}

model ApiKey {
  id              String     @id @default(auto()) @map("_id") @db.ObjectId
  key             String     @unique
  name            String
  keyType         ApiKeyType @default(LIVE)
  isActive        Boolean    @default(true)
  lastUsedAt      DateTime?
  requestCount    Int        @default(0)
  monthlyRequests Int        @default(0)
  rateLimit       Int        @default(1000)
  allowedDomains  String[]
  chatbotId       String     @db.ObjectId
  chatbot         Chatbot    @relation(fields: [chatbotId], references: [id])
  userId          String     @db.ObjectId
  user            User       @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Referral {
  id                    String @id @default(auto()) @map("_id") @db.ObjectId
  referrerId            String @db.ObjectId
  referralCode          String @unique
  referredCount         Int    @default(0)
  successfulConversions Int    @default(0)
  referrer              User   @relation("Referrer", fields: [referrerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ToolUsage {
  id             String  @id @default(auto()) @map("_id") @db.ObjectId
  chatbotId      String  @db.ObjectId
  chatbot        Chatbot @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  conversationId String? // Para rate limiting y tracking por conversaci√≥n

  toolName     String // create_payment_link, schedule_reminder, etc.
  success      Boolean @default(true)
  errorMessage String?

  // Metadata para analytics
  userMessage String? // Mensaje original del usuario
  response    String? // Respuesta generada

  // Datos espec√≠ficos seg√∫n herramienta (JSON flexible)
  metadata Json? // { amount: 500, currency: "mxn" } para stripe, { date: "2024-08-22" } para reminder

  createdAt DateTime @default(now())
}

model Widget {
  id   String @id @default(auto()) @map("_id") @db.ObjectId
  type String // 'payment', 'booking', 'form'
  data Json // Flexible: { amount, url, description, ... }

  userId    String  @db.ObjectId
  chatbotId String? @db.ObjectId

  createdAt DateTime @default(now())

  @@index([type])
}

enum ParsingStatus {
  PENDING
  PROCESSING
  COMPLETED // Parsing + embeddings exitosos
  COMPLETED_NO_VECTOR // Parsing exitoso, embeddings fallidos (puede reintentar)
  FAILED // Parsing fallido
}

enum ParsingMode {
  DEFAULT // Modo b√°sico gratuito (texto plano, URLs) - NO usa LlamaParse
  COST_EFFECTIVE // Modo econ√≥mico LlamaParse - 1 cr√©dito/p√°gina
  AGENTIC // Modo balanceado LlamaParse - 3 cr√©ditos/p√°gina
  AGENTIC_PLUS // Modo premium LlamaParse - 6 cr√©ditos/p√°gina
}

model ParsingJob {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Relaciones
  chatbotId String @db.ObjectId
  userId    String @db.ObjectId

  // Archivo
  fileName String
  fileSize Int // KB
  fileType String
  fileUrl  String? // Temporal upload

  // Configuraci√≥n
  mode    ParsingMode
  options Json // advancedOptions

  // Estado
  status ParsingStatus @default(PENDING)

  // Resultado
  resultMarkdown String?
  pages          Int?
  processingTime Float? // segundos

  // Cr√©ditos
  creditsUsed Int

  // Error
  errorMessage String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([userId])
  @@index([chatbotId])
  @@index([status])
}

// ============================================================================
// OBSERVABILITY & TRACING MODELS
// ============================================================================

enum TraceStatus {
  RUNNING
  COMPLETED
  ERROR
  CANCELLED
}

enum SpanStatus {
  RUNNING
  COMPLETED
  ERROR
}

enum SpanType {
  LLM_CALL
  TOOL_CALL
  RAG_SEARCH
  EMBEDDING
  PROCESSING
}

enum TraceEventType {
  TOOL_START
  TOOL_END
  WIDGET_DETECTED
  SOURCE_FOUND
  ERROR
  WARNING
}

model Trace {
  id             String  @id @default(auto()) @map("_id") @db.ObjectId
  chatbotId      String? @db.ObjectId
  conversationId String? @db.ObjectId
  userId         String  @db.ObjectId

  // Input/Output
  input  String
  output String?

  // Metadata b√°sica
  status     TraceStatus @default(RUNNING)
  startTime  DateTime    @default(now())
  endTime    DateTime?
  durationMs Int?

  // M√©tricas agregadas
  model       String? // Modelo LLM usado (ej: gpt-4o-mini, claude-3-5-haiku)
  totalTokens Int     @default(0)
  totalCost   Float   @default(0)
  creditsUsed Int     @default(0)

  // Relaciones
  chatbot Chatbot?     @relation(fields: [chatbotId], references: [id], onDelete: SetNull)
  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  spans   Span[]
  events  TraceEvent[]

  // Metadata flexible (tags, environment, etc.)
  metadata Json?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([chatbotId])
  @@index([conversationId])
  @@index([status])
  @@index([createdAt])
}

model Span {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  traceId      String  @db.ObjectId
  parentSpanId String? @db.ObjectId

  // Tipo de operaci√≥n
  type SpanType
  name String // Ej: "gpt-4o-mini", "search_context", "Gmail.send"

  // Timing
  startTime  DateTime
  endTime    DateTime?
  durationMs Int?

  // Input/Output espec√≠fico
  input  Json?
  output Json?

  // M√©tricas espec√≠ficas
  tokens  Int?
  cost    Float?
  credits Int?

  // Status
  status SpanStatus @default(RUNNING)
  error  String?

  // Relaciones
  trace Trace @relation(fields: [traceId], references: [id], onDelete: Cascade)

  // Metadata flexible
  metadata Json?

  createdAt DateTime @default(now())

  @@index([traceId])
  @@index([type])
  @@index([status])
}

model TraceEvent {
  id        String         @id @default(auto()) @map("_id") @db.ObjectId
  traceId   String         @db.ObjectId
  type      TraceEventType
  name      String
  data      Json?
  timestamp DateTime       @default(now())

  trace Trace @relation(fields: [traceId], references: [id], onDelete: Cascade)

  @@index([traceId])
  @@index([type])
}

// ========================================
// SAT Integration Models
// ========================================

model SatInvoice {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  userId    String @db.ObjectId // Contador
  chatbotId String @db.ObjectId

  // Cliente que subi√≥
  clientName     String?
  clientPhone    String?
  conversationId String? @db.ObjectId

  // Datos CFDI
  uuid         String   @unique
  rfcEmisor    String
  rfcReceptor  String
  nombreEmisor String
  tipo         String // INGRESO, EGRESO, NOMINA, PAGO
  fecha        DateTime
  subtotal     Float
  iva          Float
  total        Float
  concepto     String
  metodoPago   String // PUE, PPD

  // Validaci√≥n SAT (MANUAL)
  satStatus   String // PENDING_VALIDATION, VALIDATING, VALID_VIGENTE, VALID_CANCELADA
  validatedAt DateTime?
  validatedBy String?   @db.ObjectId

  // Parseo con confianza
  parseMethod String // XML_LOCAL, PDF_SIMPLE, LLAMAPARSE_CE, LLAMAPARSE_AG
  confidence  Float // 0.0 - 1.0
  status      String // APPROVED, NEEDS_REVIEW, PARSE_ERROR
  creditsUsed Int
  warnings    String[] // Alertas IA

  // Clasificaci√≥n cliente
  isDeductible Boolean?
  category     String?
  project      String?
  clientNotes  String?

  // Clasificaci√≥n IA
  aiCategory     String?
  cuentaContable String?

  // Archivos
  xmlUrl String?
  pdfUrl String?

  // Relaci√≥n con contacto
  contactId String?     @db.ObjectId
  contact   SatContact? @relation("InvoiceContact", fields: [contactId], references: [id])

  // Relaciones
  user    User    @relation("UserSatInvoices", fields: [userId], references: [id], onDelete: Cascade)
  chatbot Chatbot @relation("ChatbotSatInvoices", fields: [chatbotId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, chatbotId])
  @@index([userId, clientName])
  @@index([status]) // Filtrar pendientes de revisi√≥n
  @@index([satStatus]) // Filtrar pendientes de validar
  @@index([contactId])
}

model SatContact {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  userId    String @db.ObjectId
  chatbotId String @db.ObjectId

  // Datos b√°sicos
  rfc  String @unique
  name String
  type String // PROVEEDOR, CLIENTE, AMBOS

  // Datos SAT (validaci√≥n autom√°tica)
  satStatus        String? // ACTIVO, SUSPENDIDO, CANCELADO
  regimenFiscal    String?
  fiscalAddress    String?
  economicActivity String?

  // Lista negra
  isEFOS       Boolean   @default(false)
  isEDOS       Boolean   @default(false)
  lastSATCheck DateTime?

  // Estad√≠sticas (auto-calculadas)
  totalInvoices Int      @default(0)
  totalAmount   Float    @default(0)
  firstSeen     DateTime
  lastSeen      DateTime

  // Clasificaci√≥n IA
  category String? // "Gasolinera", "Papeler√≠a"
  tags     String[]

  // Archivos
  constanciaFiscalUrl String?

  // Relaciones
  invoices SatInvoice[] @relation("InvoiceContact")
  user     User         @relation("UserSatContacts", fields: [userId], references: [id], onDelete: Cascade)
  chatbot  Chatbot      @relation("ChatbotSatContacts", fields: [chatbotId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, chatbotId])
  @@index([type])
  @@index([isEFOS, isEDOS])
  @@index([satStatus])
}

// ============================================================================
// VOICE AI (LIVEKIT) MODELS
// ============================================================================

enum VoiceSessionStatus {
  ACTIVE
  COMPLETED
  ERROR
  CANCELLED
}

model VoiceSession {
  id             String             @id @default(auto()) @map("_id") @db.ObjectId
  userId         String             @db.ObjectId
  chatbotId      String             @db.ObjectId
  conversationId String?            @db.ObjectId

  // LiveKit Room
  roomId         String             @unique // LiveKit room ID
  roomName       String             // Human-readable room name
  participantSid String?            // Participant ID del usuario

  // Configuraci√≥n TTS usada
  ttsProvider    String             // ‚úÖ SOLO "elevenlabs" - Cartesia e Inworld DEPRECADOS
  ttsVoiceId     String?            // Voice ID espec√≠fica
  sttLanguage    String             @default("es") // ‚ö†Ô∏è ISO-639-1 SOLO (es, en, pt) - NO locales (es-MX, en-US)

  // Timing
  startTime      DateTime           @default(now())
  endTime        DateTime?
  durationMinutes Float?            // Duraci√≥n total en minutos (con decimales)

  // M√©tricas
  status         VoiceSessionStatus @default(ACTIVE)
  creditsUsed    Int                @default(0) // Cr√©ditos consumidos (5 por minuto)
  messageCount   Int                @default(0) // N√∫mero de intercambios de mensajes

  // Contenido
  transcription  String?            // Transcripci√≥n completa de la conversaci√≥n

  // Error handling
  errorMessage   String?

  // Relaciones
  chatbot        Chatbot            @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  @@index([userId, status])
  @@index([chatbotId, startTime])
  @@index([status])
}
